---
- name: Make the required grub paxctl changes.
  command: paxctl -Cpm {{ item }}
  with_items: grub_pax

- name: Find the menu title for the grsecurity kernel in GRUB config.
  set_fact:
    grub_grsecurity_menu_entry: "{{ item }}"
  with_items: grub_menu_options
  when: "{{ item.name | match('.*-grsec$') }}"

- debug: var=grub_grsecurity_menu_entry

- name: Ensure grsecurity kernel menu entry is populated.
  fail:
    msg: >
      Could not find GRUB menu entry for grsecurity kernel.
  when: grub_grsecurity_menu_entry is not defined

- name: Set grsecurity kernel as default option in GRUB config.
  sudo: yes
  lineinfile:
    regexp: '^GRUB_DEFAULT='
    line: 'GRUB_DEFAULT="{{ grub_grsecurity_menu_entry.name }}"'
    dest: /etc/default/grub

- name: Update GRUB menu information.
  command: update-grub
  when: "'grsec' not in uname_initial_result.stdout"

- name: Set grsecurity kernel as default option for next boot.
  command: grub-reboot "{{ grub_grsecurity_menu_entry.name }}"
  when: "'grsec' not in uname_initial_result.stdout"


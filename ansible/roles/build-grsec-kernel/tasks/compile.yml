---
- name: extract linux tarball
  command: tar -xf linux-{{ linux_kernel_version }}.tar
  args:
    chdir: "{{ download_directory }}"
    creates: "{{ linux_source_directory }}"

- name: apply grsecurity patch
  shell: patch -p1 < ../{{ grsecurity_patch.filename | quote }}
  args:
    chdir: "{{ linux_source_directory }}"

- name: put kernel config
  template:
    src: config
  template:
    src: config-{{ target_os }}
    dest: "{{ linux_source_directory }}/.config"

- name: get number of CPUs
  command: grep -c '^processor' /proc/cpuinfo
  register: num_cpus

- name: clean kernel source tree
  command: make-kpkg clean
  args:
    chdir: "{{ linux_source_directory }}"

- name: build the kernel for debian
  command: make-kpkg --initrd kernel_image
  args:
    chdir: "{{ linux_source_directory }}"
  environment:
    CONCURRENCY_LEVEL: "{{ num_cpus.stdout }}"
  when: target_os == 'debian'

- name: build the kernel for ubuntu
  command: make-kpkg --initrd --overlay-dir=../ubuntu-package kernel_image
  args:
    chdir: "{{ linux_source_directory }}"
  environment:
    CONCURRENCY_LEVEL: "{{ num_cpus.stdout }}"
  when: target_os == 'ubuntu'
